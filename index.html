<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Block Studio ULTRA+</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>

<style>
body { margin:0; display:flex; height:100vh; font-family:Arial; background:#121212; color:white; }
#leftPanel { width:340px; padding:15px; overflow:auto; background:#1e1e1e; }
#blocklyDiv { flex:1; height:100%; }
input, select, button {
  width:100%; margin-bottom:8px; padding:6px;
  border-radius:6px; border:none;
}
button { cursor:pointer; background:#4CAF50; color:white; }
button:hover { background:#45a049; }
.categoryItem { padding:5px; margin:3px 0; background:#333; }
</style>
</head>

<body>

<div id="leftPanel">

<h2>ðŸ‘¤ Benutzer</h2>
<input id="username" placeholder="Benutzername">
<button onclick="login()">Login / Erstellen</button>

<hr>

<h2>ðŸ“‚ Kategorie</h2>
<input id="catName" placeholder="Kategorie Name">
<input id="catColor" placeholder="Farbe 0-360">
<button onclick="addCategory()">Kategorie hinzufÃ¼gen</button>

<input id="subCatName" placeholder="Unterkategorie Name">
<button onclick="addSubCategory()">Unterkategorie hinzufÃ¼gen</button>

<hr>

<h2>ðŸ§± Block</h2>
<input id="blockType" placeholder="Block ID">
<input id="blockText" placeholder="Text z.B. sage %1">
<button onclick="addBlock()">Block hinzufÃ¼gen</button>

<hr>

<button onclick="exportWorkspace()">ðŸ“¦ Export XML</button>

</div>

<div id="blocklyDiv"></div>

<script>

let currentUser = null;
let categories = [];
let workspace;

function login(){
  const name = username.value;
  if(!name) return;

  currentUser = name;

  categories = JSON.parse(localStorage.getItem("cats_"+name)) || [
    {
      name:"Start",
      colour:200,
      blocks:[],
      subcategories:[]
    }
  ];

  initBlockly();
}

function saveAll(){
  if(!currentUser) return;

  localStorage.setItem("cats_"+currentUser, JSON.stringify(categories));

  const xml = Blockly.Xml.workspaceToDom(workspace);
  localStorage.setItem("ws_"+currentUser,
    Blockly.Xml.domToText(xml));
}

function buildToolbox(){
  let xml = '<xml>';

  categories.forEach(cat=>{
    xml += `<category name="${cat.name}" colour="${cat.colour}">`;

    if(cat.subcategories){
      cat.subcategories.forEach(sub=>{
        xml += `<category name="${sub.name}" colour="${sub.colour}">`;
        sub.blocks.forEach(b=>{
          xml += `<block type="${b}"></block>`;
        });
        xml += `</category>`;
      });
    }

    cat.blocks.forEach(b=>{
      xml += `<block type="${b}"></block>`;
    });

    xml += `</category>`;
  });

  xml += '</xml>';
  return xml;
}

function initBlockly(){
  if(workspace) workspace.dispose();

  workspace = Blockly.inject('blocklyDiv',{
    toolbox: buildToolbox()
  });

  const saved = localStorage.getItem("ws_"+currentUser);
  if(saved){
    Blockly.Xml.domToWorkspace(
      Blockly.Xml.textToDom(saved),
      workspace
    );
  }

  workspace.addChangeListener(saveAll);
}

function addCategory(){
  if(!catName.value) return;

  categories.push({
    name:catName.value,
    colour:catColor.value || 180,
    blocks:[],
    subcategories:[]
  });

  refresh();
}

function addSubCategory(){
  if(!subCatName.value) return;

  const last = categories[categories.length-1];

  last.subcategories.push({
    name:subCatName.value,
    colour:last.colour - 20,
    blocks:[]
  });

  refresh();
}

function addBlock(){
  if(!blockType.value || !blockText.value) return;

  Blockly.defineBlocksWithJsonArray([{
    type:blockType.value,
    message0:blockText.value,
    args0:[{
      type:"field_input",
      name:"TEXT",
      text:"Hallo"
    }],
    previousStatement:null,
    nextStatement:null,
    colour:160
  }]);

  const lastCat = categories[categories.length-1];

  if(lastCat.subcategories.length>0){
    lastCat.subcategories[lastCat.subcategories.length-1].blocks.push(blockType.value);
  } else {
    lastCat.blocks.push(blockType.value);
  }

  refresh();
}

function refresh(){
  workspace.updateToolbox(buildToolbox());
  saveAll();
}

function exportWorkspace(){
  const xml = Blockly.Xml.workspaceToDom(workspace);
  const data = Blockly.Xml.domToText(xml);
  const blob = new Blob([data],{type:"text/xml"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "workspace.xml";
  a.click();
}

</script>

</body>
</html>
